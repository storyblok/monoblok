---
import { getPayload, isEditorRequest, type ISbStoryData } from '@storyblok/astro';
import { storyblokApi } from '@storyblok/astro/client';
import BaseLayout from '@shared/components/BaseLayout.astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import StoryblokServerData from '@storyblok/astro/StoryblokServerData.astro';
import { getUsers, type User } from 'src/lib/getUsers';
import Widget from '@shared/components/Widget.astro';

interface ServerData {
  users?: User[];
}
interface MyStory extends ISbStoryData {
  content: { myField: string };
}
const { slug } = Astro.params;
const payload = await getPayload<ServerData, MyStory>({ locals: Astro.locals });

// Use live preview data or fetch fresh data
const story =
  payload?.story ??
  (
    await storyblokApi.get(`cdn/stories/${slug || 'home'}`, {
      version: 'draft',
      resolve_relations: ['featured-articles.posts'],
    })
  ).data.story;

const users = payload?.serverData?.users ?? (await getUsers());
const inEditor = isEditorRequest(Astro.url);
const slugs = ['test', 'about-us', 'contact'];
const disableLivePreview = slugs.includes(slug);
---

<BaseLayout>
  {disableLivePreview && <meta name="storyblok-live-preview" content="disabled" />}
  <p>{users?.length} users loaded.</p>
  <StoryblokComponent blok={story.content} />
  {inEditor && <Widget disableLivePreview={disableLivePreview} />}
</BaseLayout>
<StoryblokServerData users={users} />
