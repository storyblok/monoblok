---
import { getLiveStory } from '@storyblok/astro';
import { storyblokApi } from '@storyblok/astro/client';
import BaseLayout from '@shared/components/BaseLayout.astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import StoryblokServerData from '@storyblok/astro/StoryblokServerData.astro';
import LivePreviewSpinner from '@shared/components/LivePreviewSpinner.astro';
import { getUsers, type User } from 'src/lib/getUsers';

interface ServerData {
  users?: User[];
}

const { slug } = Astro.params;
const liveStory = await getLiveStory<ServerData>({ locals: Astro.locals });

// Use live preview data or fetch fresh data
const story =
  liveStory?.story ??
  (
    await storyblokApi.get(`cdn/stories/${slug || 'home'}`, {
      version: 'draft',
      resolve_relations: ['featured-articles.posts'],
    })
  ).data.story;

const users = liveStory?.serverData?.users ?? (await getUsers());
---

<BaseLayout>
  <p>{users?.length} users loaded.</p>
  <StoryblokComponent blok={story.content} />
  <LivePreviewSpinner />
</BaseLayout>
<StoryblokServerData users={users} />
